-- 03_trigger.sql
-- Verify: zvec_attach_table creates a trigger; the trigger correctly
-- extracts pk + vector and sends IPC for INSERT / UPDATE / DELETE.
-- NULL vector rows must be silently skipped.
CREATE TABLE zvec_test (
    id   text    PRIMARY KEY,
    vec  float4[],
    tag  text
);
-- ----------------------------------------------------------------
-- Attach trigger: should succeed and return void
-- ----------------------------------------------------------------
SELECT zvec_attach_table('test_coll', 'zvec_test', 'id', 'vec');
 zvec_attach_table 
-------------------
 
(1 row)

-- Verify trigger metadata
SELECT tgname, tgenabled
FROM pg_trigger
WHERE tgrelid = 'zvec_test'::regclass
ORDER BY tgname;
       tgname        | tgenabled 
---------------------+-----------
 zvec_sync_test_coll | O
(1 row)

-- ----------------------------------------------------------------
-- INSERT with a real vector: trigger fires, warns "collection not found"
-- ----------------------------------------------------------------
INSERT INTO zvec_test VALUES ('r1', ARRAY[1.0, 2.0, 3.0]::float4[], 'alpha');
WARNING:  zvec_sync_trigger INSERT/UPDATE failed: collection "test_coll" not found
-- ----------------------------------------------------------------
-- INSERT with NULL vector: trigger skips silently (no WARNING)
-- ----------------------------------------------------------------
INSERT INTO zvec_test VALUES ('r2', NULL, 'no-vec');
-- ----------------------------------------------------------------
-- INSERT with non-NULL vector in a different row (integer PK coercion)
-- ----------------------------------------------------------------
INSERT INTO zvec_test VALUES ('r3', ARRAY[3.0, 2.0, 1.0]::float4[], NULL);
WARNING:  zvec_sync_trigger INSERT/UPDATE failed: collection "test_coll" not found
-- ----------------------------------------------------------------
-- UPDATE changing the vector: trigger fires, warns
-- ----------------------------------------------------------------
UPDATE zvec_test
SET vec = ARRAY[1.1, 2.1, 3.1]::float4[]
WHERE id = 'r1';
WARNING:  zvec_sync_trigger INSERT/UPDATE failed: collection "test_coll" not found
-- ----------------------------------------------------------------
-- DELETE: trigger fires, warns
-- ----------------------------------------------------------------
DELETE FROM zvec_test WHERE id = 'r1';
WARNING:  zvec_sync_trigger DELETE failed: collection "test_coll" not found
-- ----------------------------------------------------------------
-- Double-attach: fails because trigger already exists
-- ----------------------------------------------------------------
SELECT zvec_attach_table('test_coll', 'zvec_test', 'id', 'vec');
ERROR:  trigger "zvec_sync_test_coll" for relation "zvec_test" already exists
CONTEXT:  SQL statement "CREATE TRIGGER zvec_sync_test_coll AFTER INSERT OR UPDATE OR DELETE ON zvec_test FOR EACH ROW EXECUTE FUNCTION zvec_sync_trigger('test_coll', 'id', 'vec')"
-- ----------------------------------------------------------------
-- Attach to non-existent table: SPI raises an error
-- ----------------------------------------------------------------
SELECT zvec_attach_table('test_coll2', 'no_such_table', 'id', 'vec');
ERROR:  relation "no_such_table" does not exist
CONTEXT:  SQL statement "CREATE TRIGGER zvec_sync_test_coll2 AFTER INSERT OR UPDATE OR DELETE ON no_such_table FOR EACH ROW EXECUTE FUNCTION zvec_sync_trigger('test_coll2', 'id', 'vec')"
-- Cleanup
DROP TABLE zvec_test CASCADE;
